function initEventsData(e,t){$.each(e,function(t,n){"undefined"!=typeof loginUserId&&void 0!==n.user&&n.user.id==loginUserId?e[t].editable=!0:e[t].editable=!1,e[t]=renameKey(e[t])}),t(e)}function renameKey(e){return e.start=e.startTime,e.end=e.endTime,delete e.startTime,delete e.endTime,e}function initTimeSlot(e){timeSlot=Array.apply(null,new Array(48)).map(Number.prototype.valueOf,0),$.each(e,function(e,t){"undefined"!=typeof loginUserId&&t.user.id==loginUserId?convertEventToSlot(t.start,t.end,"+",maxEventsInInterval):convertEventToSlot(t.start,t.end,"+",1)})}function convertEventToSlot(e,t,n,a){var r=new Date(e),o=r.getHours()+r.getMinutes()/60,l=new Date(t),i=l.getHours()+l.getMinutes()/60;switch(n){case"+":for(var s=0,u=0;u<(i-o)/.5;u++)timeSlot[2*o+s]+=a,s++;break;case"-":for(var s=0,u=0;u<(i-o)/.5;u++)timeSlot[2*o+s]-=a,s++}}function checkIdle(e,t,n,a){var r=new Date(e.format()),o=r.getHours()+r.getMinutes()/60,l=new Date(t.format()),i=l.getHours()+l.getMinutes()/60,s=0;if("update"==a){var u=new Date(originalEvent.start.format()),d=u.getHours()+u.getMinutes()/60,c=new Date(originalEvent.end.format());s=c.getHours()+c.getMinutes()/60-d}if(i-o-s>parseFloat($("#leaveAmount").text()))return!1;for(var v=0,f=0;f<(i-o)/.5;f++){if(timeSlot[2*o+v]>=n)return!1;v++}return!0}function updateEvent(e,t,n){var a=$("#calendar").fullCalendar("getView").name,r=new Date;if(e.start<r||"month"==a||"agendaWeek"==a)n();else{convertEventToSlot(originalEvent.start,originalEvent.end,"-",maxEventsInInterval);checkIdle(e.start,e.end,maxEventsInInterval,"update")?swal({title:"確認操作",text:"確認執行此步驟",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"確認",cancelButtonText:"取消"}).then(function(t){t.value?$.ajax({type:"POST",url:"../rest/event/updateEvent",data:{id:e.id,title:e.title,start:""+e.start,end:""+e.end}}).done(function(e){convertEventToSlot((e=renameKey(e)).start,e.end,"+",maxEventsInInterval),swal("操作成功","你已修改成功","success");var t=(originalEvent.end-originalEvent.start)/1e3/60/60,n=(e.end-e.start)/1e3/60/60;$("#leaveAmount").text(parseFloat($("#leaveAmount").text())+t-n)}).fail(function(){swal("操作失敗","伺服器無回應","error")}):(convertEventToSlot(originalEvent.start,originalEvent.end,"+",maxEventsInInterval),n())}):(convertEventToSlot(originalEvent.start,originalEvent.end,"+",maxEventsInInterval),swal("操作失敗","已超過可申請人/時數！","error"),n())}}var timeSlot,originalEvent;$(document).ready(function(){$.get("../rest/event/getAllEvents",function(e){initEventsData(e,function(t){t=e,$("#calendar").fullCalendar({events:t,themeSystem:"bootstrap3",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},buttonText:{today:"今日",month:"月",week:"週",day:"日",list:"list"},views:{month:{titleFormat:"YYYY 年 M 月"},week:{titleFormat:"YYYY 年 M 月 D 日",titleRangeSeparator:" ~ "},day:{titleFormat:"YYYY 年 M 月 D 日"}},timezone:"local",scrollTime:"07:00:00",allDaySlot:!1,slotEventOverlap:!1,navLinks:!0,eventLimit:!0,businessHours:[{dow:[1,2,3,4,5],start:"08:30",end:"12:00"},{dow:[1,2,3,4,5],start:"13:00",end:"17:30"}],selectable:!0,selectHelper:!0,select:function(e,t){var n=$("#calendar").fullCalendar("getView").name,a=new Date;if("undefined"==typeof loginUserId||e<a||"month"==n||"agendaWeek"==n);else{checkIdle(e,t,maxEventsInInterval,"insert")?swal({title:"請輸入事件名稱",input:"text",inputPlaceholder:"事件名稱",confirmButtonText:"確定",cancelButtonText:"取消",showCancelButton:!0,inputValidator:function(e){return!e&&"不能為空！"}}).then(function(n){var a=n.value;a&&$.ajax({type:"POST",url:"../rest/event/addEvent",data:{title:a,start:""+e,end:""+t}}).done(function(n){n.editable=!0,n=renameKey(n),$("#calendar").fullCalendar("renderEvent",n,!0),convertEventToSlot(e,t,"+",maxEventsInInterval);var a=(t-e)/1e3/60/60;$("#leaveAmount").text(parseFloat($("#leaveAmount").text())-a)}).fail(function(){swal("操作失敗","伺服器無回應","error")})}):swal("操作失敗","已超過可申請人/時數！","error")}$("#calendar").fullCalendar("unselect")},eventDragStart:function(e,t,n,a){originalEvent=e},eventDrop:function(e,t,n){updateEvent(e,t,n)},eventResizeStart:function(e,t,n,a){originalEvent=e},eventResize:function(e,t,n){updateEvent(e,t,n)},dayClick:function(e,t,n){$("#calendar").fullCalendar("gotoDate",e),$("#calendar").fullCalendar("changeView","agendaDay")},eventClick:function(e){if(e.editable){var t=new Date;e.start<t||swal({title:"事件名稱："+e.title,confirmButtonText:'刪除此事件  <i class="fa fa-arrow-right></i>',html:"開始時間："+moment(e.start).format("YYYY年M月D日 h:mm")+"<br>結束時間："+moment(e.end).format("YYYY年M月D日 h:mm"),type:"info"}).then(function(t){t.value&&$.ajax({type:"POST",url:"../rest/event/deleteEvent",data:{id:e.id}}).done(function(t){t=renameKey(t),$("#calendar").fullCalendar("removeEvents",t,!0),"agendaDay"==$("#calendar").fullCalendar("getView").name&&convertEventToSlot(e.start,e.end,"-",maxEventsInInterval),swal("已刪除","您的操作已成功","success");var n=(e.end-e.start)/1e3/60/60;$("#leaveAmount").text(parseFloat($("#leaveAmount").text())+n)}).fail(function(){swal("操作失敗","伺服器無回應","error")})})}},viewRender:function(e,t){if("agendaDay"==e.name){var n=$("#calendar").fullCalendar("getDate").toDate(),a=new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0),r=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59);initTimeSlot($("#calendar").fullCalendar("clientEvents",function(e){return e.start.toDate()>=a&&e.start.toDate()<=r||e.end.toDate()>=a&&e.end.toDate()<=r}))}},eventRender:function(e,t,n){null==e._id||("undefined"!=typeof loginUserId&&void 0!==e.user&&e.user.id==loginUserId&&t.addClass("myevent"),t.find(".fc-title").append("<br/>"+e.user.name),t.qtip({content:e.user.name,style:{classes:"qtip-dark qtip-tipsy"}}))}})})})}),$(document).ready(function(){$("#login-nav").submit(!1),$("#login-nav").submit(function(e){$.ajax({type:"POST",url:"../rest/authority/login",data:{account:$("#account").val(),pswd:$("#pswd").val()},success:function(e){window.location.reload()}}).fail(function(){swal("操作失敗","帳號或密碼錯誤！","error")})}),$("#logout").on("click",function(){$.ajax({type:"GET",url:"../rest/authority/logout"}).done(function(e){window.location.reload()}).fail(function(){swal("操作失敗","登出異常！","error")})})});